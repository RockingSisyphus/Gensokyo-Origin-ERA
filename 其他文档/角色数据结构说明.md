# 角色数据结构说明

本文档落在“项目根目录/其他文档”下，专门从“数据结构 + 语法”角度说明 **character-processor** 能识别的角色配置。先给出整体 JSON 架构，再逐项拆解各字段的可选值与行为效应。

## 1. 顶层：`stat.chars[角色ID]`

```json
{
  "name": "博丽灵梦",
  "好感度": 42,
  "所在地区": "博丽神社",
  "居住地区": "博丽神社",
  "目标": "巡视结界",
  "affectionStages": [
    {
      "threshold": 40,
      "name": "亲近",
      "describe": "会分享自己的心事，并主动邀请对方。",
      "patienceUnit": "week",
      "visit": {
        "enabled": true,
        "probBase": 0.4,
        "probK": 0.003,
        "coolUnit": "day"
      },
      "forgettingSpeed": [
        { "triggerFlag": "newMonth", "decrease": 1 }
      ],
      "affectionGrowthLimit": {
        "max": 8,
        "divisor": 3
      }
    }
  ],
  "specials": [
    {
      "when": { "byFestival": "夏日祭" },
      "action": { "do": "主持祭典", "to": "博丽神社" },
      "priority": 90
    }
  ],
  "routine": [
    {
      "when": { "byFlag": ["newMorning"] },
      "action": { "do": "打扫神社", "to": "$HOME" }
    }
  ]
}
```

> 运行期会把 `specials/routine/affectionStages` 的镜像写入 `runtime.characterSettings[角色ID]`，结构完全一致，确保决策器始终读取 runtime 版本的配置。

## 2. 基础字段

- `name: string` —— 角色展示名，聚合器与日志都会引用。  
- `好感度: number` —— 预处理根据它与 `affectionStages.threshold` 的比较来选定好感阶段，同时来访概率按 `probBase + probK * 好感度` 计算。  
- `所在地区: string | null` —— 记录当前物理位置；routine 在缺省 `to` 时会沿用该值，分区逻辑也依赖它判断是否与玩家同区。  
- `居住地区: string | null` —— 所有目的地回退（`$HOME`、`RANDOM` 失败、`to` 为空）都会优先回到这里；若缺失，最终才会退回主角位置。  
- `目标: string | undefined` —— 仅用于 UI 显示最近一次行动文案，聚合器会在写入决策时填上 `action.do`。

## 3. `affectionStages[]`

每一项遵循 `character-settings/AffectionStageWithForgetSchema`：

- `threshold: number`：阶段下限。预处理会取得“好感度 ≥ threshold”的最大阈值对应阶段。
- `name: string`：阶段名，会在ui里展示并发给ai。
- `describe?: string \| null`：说明文字，会在ui里展示并发给ai。
- `patienceUnit?: 'period' | 'day' | 'week' | 'month' | 'season' | 'year'`  
  - 角色的“耐心窗口”。当 当前时间能够触发对应值时 到了新的一天，对应day，角色被视为耐心耗尽，将执行她的日程表中规定的行动；未命中则可能继续和主角呆在一起。
- `visit?: { enabled?, probBase?, probK?, coolUnit? }`  
  - `enabled: boolean`：false 时角色永远不会尝试来访。  
  - `probBase: number`：0-1 浮点；角色来访的基础概率。  
  - `probK: number`：线性系数，按当前 `好感度` 调整来访概率。  
  - `coolUnit: 'period' | 'day' | 'week' | 'month' | 'season' | 'year'`：角色来访一次后，过多久可以再次来访。
- `forgettingSpeed?: { triggerFlag: 'newPeriod' | 'newDay' | 'newWeek' | 'newMonth' | 'newSeason' | 'newYear', decrease: number }[]`：定义“忘记”规则，角色会在对应triggerFlag标志触发时减少decrease数量的好感。
- `affectionGrowthLimit?: { max: number, divisor: number }`：为好感度单次增长值软上限；当单次增长 > `max` 时，会被调整为 `max` 与 `增长/divisor` 中较大者。

## 4. 行为条目 `Entry`

### 4.1 `when` 条件

`when` 的每个键都与 runtime 中的时钟/节日信息逐一比对：若对象为空则恒为真；若包含多个键，则需要全部成立。

1. **`byFlag?: string[]`**  
   - 允许使用 `runtime.clock.flags` 下的所有布尔路径。根级可写：`newPeriod`, `newDay`, `newWeek`, `newMonth`, `newSeason`, `newYear`。  
   - 季节分支可写：`bySeason.newSpring`, `bySeason.newSummer`, `bySeason.newAutumn`, `bySeason.newWinter`。  
   - 时段分支可写：`byPeriod.newDawn`, `byPeriod.newMorning`, `byPeriod.newNoon`, `byPeriod.newAfternoon`, `byPeriod.newDusk`, `byPeriod.newNight`, `byPeriod.newFirstHalfNight`, `byPeriod.newSecondHalfNight`。  
   - 数组中可混合多个路径，只要其中任意一个为 `true` 就视为 `byFlag` 成立。

2. **`byNow?: Partial<Clock['now']>`**  
   - 支持以下键：`iso`, `year`, `month`, `day`, `weekdayIndex`, `weekdayName`, `periodName`, `periodIdx`, `minutesSinceMidnight`, `seasonName`, `seasonIdx`, `hour`, `minute`, `hm`。  
   - 其中 `weekdayName` 只能取 `周一`、`周二`、`周三`、`周四`、`周五`、`周六`、`周日`；`periodName` 只能取 `清晨`、`上午`、`中午`、`下午`、`黄昏`、`夜晚`、`上半夜`、`下半夜`。。  
   - 所有写出的属性必须全部满足，才会触发。例如 `{ "periodName": "上午", "weekdayIndex": 1 }` 表示“周一上午”。

3. **`byMonthDay?: { month: number; day: number }`**  
   - 用于固定月日（例如生日）。只有当 `clock.now.month === month` 且 `clock.now.day === day` 时触发，年份与星期无关。

4. **`byFestival?: 'ANY' | string | string[]`**  
   - `'ANY'`：只要 `runtime.festival.current` 存在并且 `name` 非空即可。  
   - 单个字符串：与当前节日名精确匹配，例如 `"夏日祭"`。  
   - 字符串数组：数组中任一名称与当前节日名相等就成立，例如 `["正月", "节分"]`。

-### 4.2 `action`

整体规则：多个键之间需要全部满足；`byFlag` 和 `byFestival` 内部数组则是“命中其一即可”。

### 4.2 `action`

- `do: string` —— 必填，描述“做什么”，会在 UI 中展示，也会同步给 AI。  
- `to?: string` —— 可省略或写特殊语法：  
  - 留空：保持在当前 `所在地区`。  
  - `HERO`：强制前往玩家当前位置（唯一仍会落到玩家位置的情况）。  
  - `$HOME`：前往角色的 `居住地区`；若该字段为空，会继续尝试以 `居住地区` 作为所有回退地点，确实缺失时才最终退回玩家位置。  
  - `RANDOM`：从 `runtime.area.legal_locations` 中随机抽取；若抽取失败或列表为空，则回退到角色 `居住地区`，若该字段缺失才最终退回玩家位置。  
  - 其他字符串：当作具体地点名直接写入。  
- `from?: string` —— 系统会自动填入行动开始前的 `所在地区`，配置时无需手动赋值。  
- `source?: string` —— 标记行动来源；`visit`/`companion` 等系统生成的决策会自动设置，若自定义动作需要特殊后续逻辑可自行填入。

### 4.3 `priority`

仅在 `specials` 中生效：同一拍点有多个 `specials` 命中时取 `priority` 最大者；若数值相同则按照数组顺序选择。`routine` 无视该字段。
