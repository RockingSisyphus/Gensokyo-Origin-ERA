# ERA 数据结构文档 (stat & runtime)

本文档详细说明了幻想乡缘起 ERA 框架中两个核心状态对象——`stat` 和 `runtime`——的理论上的完整数据结构及其各个组成部分的功能。

## 概述

- **`stat`**: 代表了在一次完整的 AI 生成周期中，传递给模型（LLM）的**上下文数据**。它是一个高度结构化、经过处理和裁剪的对象，旨在为 AI 提供生成回复所需的所有相关信息。它通常包含了世界信息、角色状态、当前时间、地点、正在发生的事件等。`stat` 的内容是**只读的**，AI 的输出不应直接修改它。

- **`runtime`**: 代表了 ERA 框架在后台维护的**运行时状态**。它包含了 `stat` 的所有数据，以及更多仅供框架内部逻辑使用、不应暴露给 AI 的数据。例如，它可能包含内部计数器、缓存、复杂的角色关系图、待处理事件队列等。`runtime` 是**可读写的**，框架中的各个处理器会根据游戏逻辑不断更新它。

---

## `stat` 对象结构详解

`stat` 对象是 AI 感知到的“世界状态”的快照。其主要属性如下：

### `config`

`config` 对象包含了控制游戏核心机制的各种配置参数。这些参数通常在游戏开始时设定，并在运行时保持不变。

-   **`affection`**: 好感度系统配置。
    -   `affectionStages`: 定义了好感度的不同阶段，以及每个阶段的具体参数，例如进入下一阶段所需的好感度阈值、此阶段下的特殊行为或对话修正、以及好感度遗忘机制的参数等。
-   **`time`**: 时间系统配置。
    -   `epochISO`: 定义了游戏世界的“创世时间”，是一个标准的 ISO 8601 格式的日期时间字符串。所有游戏内的时间计算都以此为基准。
    -   `flagHistoryLimits`: 为时间流逝过程中产生的各种时间标记（如 `newDay`, `newSeason` 等）配置了历史追溯的限制。这主要用于防止在聊天记录中进行大幅度的时间跳跃时，系统状态出现不一致。
-   **`incident`** (可选): 突发事件系统配置。
    -   `cooldownMinutes`: 事件发生的冷却时间（分钟）。
    -   `forceTrigger`: 是否强制触发一个事件。
    -   `isRandomPool`: 是否从一个随机池中挑选事件。
    -   `pool`: 事件池，包含了一系列可供选择的事件定义。每个事件定义包括名称、描述和主要发生地点。
    -   `randomCore` / `randomType`: 用于随机事件生成的其他参数。

### `chars`

`chars` 对象是一个以角色 ID（`string` 类型）为键的字典，每个键对应一个详细的角色信息对象。它存储了所有在当前场景中活跃或相关的角色的状态。

-   **`[characterId]`**: 角色对象，包含以下属性：
    -   `name`: 角色的姓名。
    -   `好感度`: 玩家对该角色的好感度数值。
    -   `所在地区`: 角色当前所在的地点名称。如果角色不在任何已知地点，则为 `null`。
    -   `居住地区`: 角色的固定居住地。
    -   `affectionStages`: (默认 `[]`) 一个数组，定义了该角色**特有**的好感度阶段。这会覆盖 `config.affection.affectionStages` 中的全局设定。
    -   `specials`: (默认 `[]`) 一个数组，定义了该角色的特殊行为或状态。每个条目（`EntrySchema`）通常包含触发条件和对应的行为描述。
    -   `routine`: (默认 `[]`) 一个数组，定义了该角色的日常行动规律。
    -   `目标` (可选): 角色当前的行动目标或意图的文字描述。

### `user`

`user` 对象代表了玩家（用户）在游戏世界中的状态。

-   `姓名`: 玩家的姓名。
-   `所在地区`: 玩家当前所在的地点。
-   `居住地区`: 玩家的固定居住地。

### `world` (可选)

`world` 对象描述了游戏世界的宏观结构，主要是地理和地图信息。

-   `map_graph` (可选): 定义了游戏世界的地图结构。
    -   `mapSize`: 地图的整体尺寸（宽度和高度）。
    -   `tree`: 一个树状结构，描述了地点的层级关系（例如，国家 -> 地区 -> 城市 -> 具体建筑）。树的叶子节点 (`MapLeaf`) 代表具体的可访问地点，包含其在地图上的坐标 (`pos`) 和一个用于前端显示的 HTML 元素 (`htmlEle`)。
    -   `edges` (可选): 一个数组，定义了地点之间的连接关系（路径）。
    -   `aliases` (可选): 一个字典，为地点名称提供别名。
-   `fallbackPlace`: 一个备用地点名称，当无法确定角色或玩家的位置时，会使用这个地点作为默认位置。

### `time`

`time` 对象包含了一些全局性的、影响整个世界运行状态的参数。

-   `timeProgress`: 一个数字，表示时间的流逝速度或倍率。

### `cache` (可选)

`cache` 对象用于存储一些计算的中间结果或状态，以提高性能。虽然它更多地在 `runtime` 中被使用，但在 `stat` 中也可能出现，用于传递某些特定的缓存信息。

-   `time`: 时间相关的缓存。
    -   `clockAck`: (可选) 缓存了上一次时间处理器确认过的时间点信息，用于避免重复处理。
-   `incident`: 事件相关的缓存。
    -   `incidentCooldownAnchor`: (可选) 记录了上一次事件发生的时间戳，用于计算冷却时间。
-   `character`: 角色相关的缓存，以角色 ID 为键。
    -   `[characterId]`:
        -   `visit`: (可选) 访问相关的缓存，例如 `cooling` 标记是否处于访问冷却中。
-   `timeChatMkSync`: 时间与聊天记录同步相关的缓存。

### `incidents`

`incidents` 对象记录了当前正在发生或最近发生的“异变”（即突发事件）。它是一个以异变名称为键的字典。

-   **`[incidentName]`**: 异变详情对象，包含以下属性：
    -   `异变细节`: 对异变的详细文字描述。
    -   `主要地区`: 异变发生的主要地区列表。
    -   `异变退治者` (可选): 解决或正在解决该异变的角色名称或名称列表。
    -   `异变已结束`: 一个布尔值，标记该异变是否已经结束。

### `festivals_list`

`festivals_list` 是一个数组，包含了游戏中所有已定义的节日信息。

-   **数组元素**: 每个元素都是一个节日定义对象，包含以下属性：
    -   `name`: 节日的名称。
    -   `month`: 节日所在的月份。
    -   `start_day`: 节日开始的日期。
    -   `end_day`: 节日结束的日期。
    -   `host` (可选): 节日的主办方或主要关联角色。
    -   `customs` (可选): 一个描述节日习俗的字符串数组。

### `文文新闻` (可选)

一个字符串，包含了由角色“射命丸文”发布的最新新闻内容。这通常用于向 AI 提供当前世界的动态信息或最近发生的大事件的摘要。

---

## `runtime` 对象结构详解

`runtime` 对象是框架内部维护的、完整的、可写的世界状态。它**并不**直接继承 `stat` 的所有属性，而是包含了一系列用于计算和生成 `stat` 的、更原始或更详细的运行时数据。

### `incident` (可选)

`runtime.incident` 提供了比 `stat.incidents` 更详细的事件运行时信息，主要用于事件处理器的内部决策。

-   `decision`: 事件处理器的决策，可能是 `'continue'` (继续当前事件), `'start_new'` (开启新事件), 或 `'daily'` (日常处理)。
-   `current` (可选): 当前正在发生的事件的详细运行时信息 (`IncidentRuntimeInfo`)。
-   `spawn` (可选): 一个新生成的、待处理的事件。
-   `remainingCooldown` (可选): 距离下一次可以触发新事件的剩余冷却时间。
-   `isIncidentActive`: 一个布尔值，标记当前是否有任何活动事件。

### `clock` (可选)

`clock` 对象是游戏世界的核心时钟，提供了关于当前时间的详尽信息。

-   `now`: 包含了当前时间的各种表示方式。
    -   `iso`: 当前时间的 ISO 8601 格式字符串。
    -   `year`, `month`, `day`, `hour`, `minute`: 年、月、日、时、分。
    -   `weekdayIndex`, `weekdayName`: 星期几的索引和名称。
    -   `periodName`, `periodIdx`: 一天中不同时段（如“清晨”、“上午”）的名称和索引。
    -   `seasonName`, `seasonIdx`: 季节的名称和索引。
    -   `minutesSinceMidnight`: 从午夜开始经过的分钟数。
    -   `hm`: "HH:mm" 格式的时间字符串。
-   `flags`: 一系列布尔标记，用于指示时间单位的“翻篇”。
    -   `newPeriod`, `newDay`, `newWeek`, `newMonth`, `newSeason`, `newYear`: 标记是否进入了新的时段、天、周、月、季节、年。
    -   `byPeriod`: 更精细的时段标记，如 `newMorning` (进入上午), `newNight` (进入夜晚) 等。
    -   `bySeason`: 更精细的季节标记，如 `newSpring` (进入春天) 等。
-   `mkAnchors` (可选): 将时间流逝的 `flags` 与具体的聊天消息密钥（MK）关联起来，形成时间锚点。这对于在历史聊天记录中准确地重建当时的时间状态至关重要。
-   `previousMkAnchors` (可选): 上一次的时间锚点信息，用于比较和计算时间差。

### `area` (可选)

`area` 对象包含了关于世界地理和地图的详细运行时信息，用于路径规划和地点管理。

-   `graph`: 一个邻接表表示的图，存储了地点之间的连接关系。
-   `legal_locations`: 一个包含所有合法、可访问地点的数组。
-   `neighbors`: 当前地点周围的邻近地点列表。
-   `loadArea`: 需要加载的区域列表。
-   `route`: 路径规划信息。
    -   `candidates`: 路径规划的候选目标地点。
    -   `routes`: 计算出的一系列到达候选地点的具体路径 (`RouteSchema`)。每个路径包含目的地和详细的步骤。
-   `mapSize` (可选): 地图的整体尺寸。

### `festival` (可选)

`festival` 对象提供了关于当前和即将到来的节日的详细运行时信息。

-   `ongoing`: 布尔值，标记当前是否正处于某个节日期间。
-   `upcoming`: 布尔值，标记近期是否将有节日到来。
-   `current`: 如果当前有节日，此字段将包含该节日的详细信息（名称、主办方、习俗、起止日期等）。否则为 `null`。
-   `next`: 下一个即将到来的节日的详细信息，包括距离现在的天数 (`days_until`)。如果不存在下一个节日，则为 `null`。

### `characterDistribution` (可选)

`characterDistribution` 对象描述了所有角色（包括玩家和 NPC）在世界地图上的分布情况。

-   `playerLocation`: 玩家当前所在的地点名称。
-   `npcByLocation`: 一个以地点名称为键的字典，值为一个包含该地点所有 NPC 角色 ID 的数组。

### `character` (可选)

`runtime.character` 提供了比 `stat.chars` 更深入的角色运行时信息，主要用于角色行为决策和分组。

-   `chars`: 一个以角色 ID 为键的字典，值为该角色的运行时信息 (`CharacterRuntimeSchema`)。
    -   `affectionStage` (可选): 角色当前所处的好感度阶段的完整定义。
    -   `decision` (可选): 角色AI做出的主要行动决策 (`ActionSchema`)，包含 `do` (做什么), `to` (对谁/去哪里), `from` (从哪里来), `source` (决策来源)等。
    -   `companionDecision` (可选): 作为同伴时的行动决策。
-   `partitions`: 对角色进行分组的结果。
    -   `coLocated`: 与玩家在同一地点的角色 ID 列表。
    -   `remote`: 不与玩家在同一地点的角色 ID 列表。

### `characterLog` (可选)

一个自由格式的对象，用于记录和存储角色的历史行动、对话或其他重要事件的日志。其具体结构由使用它的处理器定义。

### `characterSettings` (可选)

一个以角色 ID 为键的字典，聚合了所有角色的、从外部（如角色卡）加载的详细配置。

-   **`[characterId]`**: 单个角色的设置对象 (`CharacterSettingsSchema`)。
    -   `id`: 角色 ID。
    -   `name`: 角色名称。
    -   `affectionStages`: 该角色完整的好感度阶段定义，包括遗忘规则 (`forgettingSpeed`)、拜访概率 (`visit`)、好感度增长限制 (`affectionGrowthLimit`) 等。
    -   `specials`: 角色的特殊行动规则列表。
    -   `routine`: 角色的日常行动规则列表。

### `snapshots` (可选)

一个数组，存储了从 `era:queryResult` 事件中获取的一系列历史状态快照 (`QueryResultItem`)。这通常用于需要回溯历史以进行分析或决策的处理器。

-   **数组元素**: 每个元素都是一个历史快照对象，包含：
    -   `mk`: 该快照对应的消息密钥。
    -   `message_id`: 该快照对应的消息 ID。
    -   `is_user`: 消息是否由用户发出。
    -   `stat` / `statWithoutMeta`: 该时间点的完整 `stat` 对象。

### `ayaNews` (可选)

`runtime.ayaNews` 是 `stat.文文新闻` 的原始数据结构，包含了生成最终新闻稿所需的所有条目。

-   `entries`: 一个新闻条目 (`AyaNewsEntry`) 的数组。
    -   `location`: 新闻发生的地点。
    -   `otherCharacters`: 该地点的其他角色信息列表。
    -   `target`: 射命丸文的当前目标。
    -   `clockAck`: 该条目记录时的时间戳。
