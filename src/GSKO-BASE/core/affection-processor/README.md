# `stat-processor/affection-processor` 模块说明

## 1. 模块职责

本模块是一个**数据修正器 (Data Corrector)**，其核心职责是**平滑好感度的剧烈变化**。

它不创建新数据，而是监听 `stat` 对象中角色好感度的更新。当检测到某次更新的数值变化过大时（例如，一次性增加或减少超过 2 点），它会根据预设的折算规则，将这个大的变化量“折算”成一个更小、更温和的步长。然后，它会用这个折算后的新值**直接修改并覆盖** `stat` 对象中原始的、过大的更新值。

这样做的目的是为了防止因单次事件导致好感度数值跳变过大（如从 -100 直接到 +100），从而使角色的情感变化在叙事上显得更加平滑和合理。

## 2. 读取的数据

本模块的输入是 `stat` 和 `editLog`。它通过分析 `editLog` 来决定如何修改 `stat`。

- **`editLog`** (`object[]` | `string`, 必须)
  - **读取内容**: 模块会解析 `editLog` 中的所有 `update` 类型的操作。对于每个 `update` 操作，它会提取出所有原子级的路径变更，特别是每个变更的 `path`、`oldVal`（变更前的值）和 `newVal`（变更后的原始目标值）。
  - **读取目的**: `oldVal` 和 `newVal` 是计算原始变化量 `delta` 的基础，这是整个折算逻辑的起点。
  - **示例**: 如果 `editLog` 中有 `{ "op": "update", "value": { "chars": { "reimu": { "好感度": 30 } } } }`，并且 `stat` 中之前的 `好感度` 是 `10`，模块会捕获到 `path: 'chars.reimu.好感度'`, `oldVal: 10`, `newVal: 30`。

- **`stat`** (`object`, 必须)
  - **读取内容**: 虽然 `stat` 对象被整体传入，但在“读取”阶段，模块主要用它来**确认 `oldVal`**（如果 `editLog` 中没有提供）。
  - **读取目的**: `stat` 对象是修改的目标。模块读取它是为了在后续步骤中对其进行直接修改。

## 3. 执行逻辑

模块的执行逻辑可以看作是一次“拦截与修正”的过程：

1. **解析日志**: 接收 `editLog`，解析成标准的 `EditLogOp[]` 格式，并筛选出所有的 `update` 操作。
2. **遍历变更**: 将 `update` 操作分解为原子级的路径变更（`{ path, oldVal, newVal }`）。
3. **目标判断**: 对每一个路径变更，使用正则表达式 `^chars\.[^.]+\.好感度$` 进行判断。如果路径不匹配（例如，`user.所在地区`），则忽略该变更。
4. **计算变化量**: 对于匹配的路径，计算原始变化量 `delta = newVal - oldVal`。
5. **阈值判断**:
    - 检查 `delta` 的绝对值。如果 `abs(delta)` 小于或等于 `MIN_STEP` (默认为 2)，则认为变化是温和的，无需处理，跳过该变更。
6. **执行折算**:
    - 如果 `abs(delta)` 大于 `MIN_STEP`，则进行折算。
    - 折算后的步长 `step` 计算公式为 `max(MIN_STEP, ceil(abs(delta) / FOLD_RATIO))`，其中 `FOLD_RATIO` 默认为 5。
    - 保留原始变化的方向，得到最终的折算变化量 `foldedDelta` (例如, 如果 `delta` 是 -20, `foldedDelta` 就是 -4)。
7. **修改 `stat` (覆盖逻辑)**:
    - 计算出最终值 `foldedNewValue = oldVal + foldedDelta`。
    - **这是核心步骤**: 模块使用 `_.set(stat, path, foldedNewValue)` 将这个新计算出的、更温和的值**直接写回到 `stat` 对象**的相应路径上。
    - 这个操作**覆盖**了 `editLog` 中原本打算写入的那个过大的 `newVal`。因此，传递到下一个处理环节的 `stat` 对象，其好感度已经被修正了。
8. **记录变更日志**: 将本次折算操作的详情（包括路径、原始值、新值和原因）记录到一个 `changes` 数组中，并作为函数结果返回，以便外部系统了解发生了什么修正。

## 4. 写入/修改的数据

本模块不向 `runtime` 写入数据。它的主要副作用是**直接修改传入的 `stat` 对象**。

- **`stat.chars[charId].好感度`** (`number`)
  - **修改逻辑**: 如果 `editLog` 中对该路径的更新被判定为剧烈变化，该路径的值将被**覆盖**为折算后的新值。
  - **覆盖示例**:
    - **初始状态**: `stat.chars.reimu.好感度` 为 `10`。
    - **外部操作**: 一个事件试图将好感度设置为 `30`，因此 `editLog` 记录了 `newVal: 30`。
    - **模块介入**:
      - 模块捕获到 `oldVal: 10`, `newVal: 30`。
      - 计算出原始 `delta` 为 `+20`。
      - `abs(20)` > `MIN_STEP`(2)，需要折算。
      - 折算步长 `step = max(2, ceil(20 / 5)) = 4`。
      - 折算后的 `foldedDelta` 为 `+4`。
      - 模块计算出的最终值为 `10 + 4 = 14`。
    - **最终结果**: 模块执行 `_.set(stat, 'chars.reimu.好感度', 14)`。因此，当此函数返回时，`stat.chars.reimu.好感度` 的值**不是 `30`，而是 `14`**。

## 5. 返回的数据

函数返回一个对象 `{ stat: any; changes: ChangeLogEntry[] }`。

- **`stat`**: 经过可能修改后的 `stat` 对象。
- **`changes`**: 一个 `ChangeLogEntry` 数组，记录了本模块执行的所有折算操作。如果未进行任何折算，则为空数组。每个 `ChangeLogEntry` 对象包含以下字段：
  - **`module`** (`string`): 触发变更的模块名。在此模块中，固定为 `'affection-processor'`。
  - **`path`** (`string`): 被修改的数据路径，例如 `'chars.reimu.好感度'`。
  - **`oldValue`** (`any`): 修改前的原始值。
  - **`newValue`** (`any`): 修改后的折算值。
  - **`reason`** (`string`): 描述变更原因的文本，例如 `"好感度折算：原始变化量 20 被折算为 4"`。
