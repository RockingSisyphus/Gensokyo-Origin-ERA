# `runtime-builder/affection-level` 模块说明

## 1. 模块职责

本模块的核心职责是根据每个角色的好感度数值和在 `stat.config` 中定义的好感度等级阈值，计算出每个角色当前的好感度等级名称（例如“友善”、“信赖”等），并将这个等级名称写入 `runtime` 对象。

该模块遵循“显式覆盖”原则，在计算开始前会先清空上一轮在 `runtime` 中留下的所有角色的好感度等级数据，然后再写入本轮的计算结果。

## 2. 读取的数据

本模块主要从 `stat` 对象中读取数据。

### 2.1. 从 `stat` 读取

- **`stat.config.affection.affectionStages`** (`string[]`, 必须)
  - 描述：定义了好感度等级的阈值和名称。这是一个字符串数组，如果不存在或无法解析，则模块会跳过计算。
  - 数组中每个字符串的格式为 `"[阈值, \"等级名称\"]"`。
  - 示例：

        ```json
        [
          "[-100, \"嫌恶\"]",
          "[-50, \"警惕\"]",
          "[0, \"普通\"]",
          "[50, \"友善\"]",
          "[100, \"信赖\"]"
        ]
        ```

- **`stat.chars`** (`object`, 必须)
  - 描述：一个包含所有角色数据的对象，键为角色 ID。
  - 模块会遍历此对象，并读取每个角色下的 `好感度` 字段。
  - **`stat.chars[charId].好感度`** (`number`): 角色的好感度数值。只有当这个值是数字类型时，才会为其计算等级。

## 3. 执行逻辑

1. **清理旧数据**：在计算开始前，模块会遍历 `runtime.chars`，并删除其中每个角色下已存在的 `好感度等级` 字段，以确保不会保留上一轮的旧数据。
2. **解析配置**：
    - 读取 `stat.config.affection.affectionStages` 配置数组。
    - 内部的 `parseAffectionStages` 函数会遍历这个数组，使用正则表达式将每个字符串（如 `"[50, \"友善\"]"`）解析成一个包含阈值和名称的元组（如 `[50, "友善"]`）。
    - 如果配置不存在或解析结果为空，则中止后续所有操作。
3. **遍历角色并计算等级**：
    - 遍历 `stat.chars` 对象中的每一个角色。
    - 对每个角色，获取其 `好感度` 数值。
    - 如果好感度值存在且为数字，则调用 `calculateAffectionLevel` 函数。
    - `calculateAffectionLevel` 函数会将好感度数值与所有已解析的等级阈值进行比较，并返回该数值所能达到的最高等级的名称。例如，如果好感度为 60，它会匹配到 `[50, "友善"]` 而不是 `[0, "普通"]`。
4. **写入 Runtime**：将计算出的好感度等级字符串，通过 `set` 函数写入到 `runtime.chars[charId].好感度等级` 路径下。

## 4. 写入的数据

模块执行成功后，会向 `runtime.chars` 对象中写入（或覆盖）每个角色的 `好感度等级` 字段。

- **`runtime.chars[charId].好感度等级`** (`string`)
  - 描述：根据角色好感度数值计算出的等级名称。
  - 示例：如果角色 `reimu` 的好感度是 `75`，并且配置如上所示，那么写入的数据将是：

        ```json
        {
          "chars": {
            "reimu": {
              "好感度等级": "友善"
            }
            // ... 其他角色的数据
          }
        }
